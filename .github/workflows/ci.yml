name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            %USERPROFILE%\.cargo\registry
            %USERPROFILE%\.cargo\git
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Rust fmt check
        run: cargo fmt --all -- --check

      - name: Build and test workspace
        run: cargo test --all --workspace --verbose

      - name: Run vector verification (Python)
        run: |
          python tools/verify_vectors.py

      - name: Generate vectors (Rust example)
        run: |
          python - << 'PY'
import subprocess, sys, os
out_path = os.path.join('crates','tenebrium-utxo','test_vectors','generated_vectors.json')
with open(out_path, 'wb') as f:
    subprocess.check_call(['cargo','run','-p','tenebrium-utxo','--example','generate_vectors'], stdout=f)
PY

      - id: check_vectors
        name: Compare generated vs committed vectors
        shell: bash
        run: |
          # compare JSON files in a stable way and set outputs 'different', 'changed_count' and 'sample_changed'
          python - << 'PY' > /tmp/vector_diff.txt
import json
from pathlib import Path

a = json.load(open('crates/tenebrium-utxo/test_vectors/vectors.json'))
b = json.load(open('crates/tenebrium-utxo/test_vectors/generated_vectors.json'))

changed_count = 0
changed_indices = []
if isinstance(a, list) and isinstance(b, list):
    for i in range(max(len(a), len(b))):
        ai = a[i] if i < len(a) else None
        bi = b[i] if i < len(b) else None
        if ai != bi:
            changed_indices.append(i)
    changed_count = len(changed_indices)
else:
    changed_count = 0 if a == b else 1

sample = ','.join(map(str, changed_indices[:10]))
print(f"different={'true' if a != b else 'false'}")
print(f"changed_count={changed_count}")
print(f"sample_changed_indices={sample}")
PY
          DIFF=$(sed -n '1p' /tmp/vector_diff.txt | cut -d'=' -f2)
          COUNT=$(sed -n '2p' /tmp/vector_diff.txt | cut -d'=' -f2)
          SAMPLE=$(sed -n '3p' /tmp/vector_diff.txt | cut -d'=' -f2)
          echo "different=$DIFF" >> $GITHUB_OUTPUT
          echo "changed_count=$COUNT" >> $GITHUB_OUTPUT
          echo "sample_changed=$SAMPLE" >> $GITHUB_OUTPUT
          if [ "$DIFF" = "true" ]; then echo "Generated vectors differ ❌ ($COUNT entries changed). Sample indices: $SAMPLE"; else echo 'Generated vectors match ✔️'; fi

      - name: Prepare commit (overwrite committed vectors with generated)
        if: steps.check_vectors.outputs.different == 'true'
        shell: bash
        env:
          CHANGED_COUNT: ${{ steps.check_vectors.outputs.changed_count }}
        run: |
          mv crates/tenebrium-utxo/test_vectors/generated_vectors.json crates/tenebrium-utxo/test_vectors/vectors.json
          git add crates/tenebrium-utxo/test_vectors/vectors.json
          git commit -m "chore(test-vectors): update ${CHANGED_COUNT} vectors" || true
          git status --porcelain || true

      - name: Create Pull Request for updated vectors
        if: steps.check_vectors.outputs.different == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: auto/update-test-vectors-${{ github.run_id }}-${{ steps.check_vectors.outputs.changed_count }}
          commit-message: "chore(test-vectors): update ${{ steps.check_vectors.outputs.changed_count }} vectors"
          title: "chore(test-vectors): update ${{ steps.check_vectors.outputs.changed_count }} generated test vectors"
          body: |-
            Automated update of test vectors generated by CI.

            **Changed entries:** ${{ steps.check_vectors.outputs.changed_count }}

            **Sample changed indices (first 10):**
            ```
            ${{ steps.check_vectors.outputs.sample_changed }}
            ```
          labels: "auto-generated, test-vectors"
          base: main

      - name: Upload vector artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tenebrium-utxo-vectors
          path: |
            crates/tenebrium-utxo/test_vectors/vectors.json
            crates/tenebrium-utxo/test_vectors/generated_vectors.json

      - name: List test vectors
        run: python -c "import os,sys; print('\n'.join(os.listdir('crates/tenebrium-utxo/test_vectors')))"
